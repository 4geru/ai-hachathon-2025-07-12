# Sky Canvas - 設計判断と技術選択

## 1. モバイルアプリとディスプレイアプリの構成

### 1.1. 構成案の検討

現状の企画では、スマートフォンをコントローラーとする「モバイルアプリ」と、花火を表示する「ディスプレイアプリ」の2つのコンポーネントが存在します。これらをどのように実装するか、以下の2つの構成案を検討します。

#### 1.1.1. 構成案A: アプリケーションを分離する

**概要:**
スマートフォン用Webアプリとディスプレイ用Webアプリをそれぞれ独立したアプリケーションとして開発・デプロイします。Supabase Realtimeを介して連携します。

**メリット:**
- **役割分担の明確化:** 各アプリの責務が明確になり、開発がしやすい。
- **技術スタックの最適化:** モバイルアプリはセンサー連携、ディスプレイアプリはWebGL描画に特化した技術選択が可能。
- **デプロイの柔軟性:** それぞれ独立してデプロイ、更新が可能。
- **パフォーマンス最適化:** 各デバイスの性能に合わせたチューニングが可能。
- **スケーラビリティ:** 必要に応じてそれぞれのアプリをスケールさせやすい。

**デメリット:**
- **開発コスト:** 2つの独立したプロジェクトを管理する必要がある。
- **バージョン管理:** 連携を維持するためのバージョン管理が複雑になる可能性。

**考慮事項:**
- 共通のデータ型定義やユーティリティ関数を共有ライブラリとして管理することで、コードの重複を最小限に抑えることが可能。
- CI/CDパイプラインで連携テストを自動化し、バージョン間の互換性問題を早期に発見する。

#### 1.1.2. 構成案B: 単一のアプリケーションとして統合する

**概要:**
1つのWebアプリケーション内で、ユーザーエージェント（スマートフォン/PC）に基づいて表示内容を切り替える構成です。例：PCでアクセスした場合はディスプレイモード、スマホでアクセスした場合はコントローラーモード。

**メリット:**
- **開発・管理の簡素化:** 1つのコードベースで済むため、開発、デプロイ、メンテナンスが容易。
- **コードの共有:** ロジックやUIコンポーネントを最大限に共有できる。
- **バージョン管理の簡素化:** 常に同じバージョンで動作するため、互換性の問題が発生しにくい。

**デメリット:**
- **責務の肥大化:** 1つのアプリに複数の機能が詰め込まれ、コードが複雑になる可能性。
- **パフォーマンスの制約:** 全体最適化が必要となり、特定デバイス向けの最適化が難しい場合がある。
- **技術選択の制約:** 両方の要件を満たす技術を選択する必要がある。

**考慮事項:**
- コードベース内で役割に応じて適切にモジュールを分離する。
- レスポンシブデザインやメディアクエリを活用し、デバイスに合わせた表示切り替えを実装する。

### 1.2. 結論と採用案

現時点での「Sky Canvas」プロジェクトの特性（リアルタイム連携、パフォーマンス重視、ハッカソンでのデモインパクト）を考慮すると、**構成案A（アプリケーションを分離する）** を採用することが適切であると判断します。ただし、ご提案いただいた「花火を飛ばす仕組み」のような**共通するロジックやデータモデルについては、共有モジュールとして管理**し、コードの重複を避け、一貫性のある開発を行います。

**理由:**
1.  **パフォーマンス最適化の優先:** スマートフォンはセンサーデータの送信とバイブレーション、ディスプレイはWebGLによる描画とWeb Audioによる音楽生成と、それぞれ異なる処理負荷と要求スペックを持ちます。これらを分離することで、各デバイスの特性に応じた最適なパフォーマンスチューニングが可能になります。
2.  **開発の独立性:** 各チームがそれぞれのコンポーネントに集中して開発を進められるため、並行開発の効率が向上します。ハッカソンという限られた時間の中で、この独立性は大きなメリットとなります。
3.  **技術的専門性の集中:** センサーデータの処理、WebGLグラフィック、リアルタイム通信など、それぞれのコンポーネントが異なる技術的専門性を要求します。分離することで、それぞれの専門家が自身の領域に集中し、高品質な実装を目指せます。
4.  **デモの明確さ:** デモ時に「これはスマホアプリ、これがディスプレイアプリ」と役割を明確に説明できるため、審査員へのアピールも容易になります。
5.  **共通ロジックの効率的な管理:** 花火の発射ロジックや、Supabaseとのデータ連携インターフェースなど、両方のアプリケーションで共通して利用される部分を独立したパッケージとして管理することで、一貫性を保ちつつ開発効率を高めます。

### 1.3. 共通部分の管理戦略

共通部分のコードを効率的に管理するために、以下の戦略を採用します。

-   **モノレポ（Monorepo）の採用検討:** TurborepoやNxのようなツールを使用して、単一のリポジトリ内で複数のパッケージ（`mobile-app`, `display-app`, `common-utils` など）を管理します。これにより、コードの共有が容易になり、依存関係の管理も簡素化されます。
-   **共有パッケージの定義:**
    -   **`@skycanvas/types`:** Supabaseとの間でやり取りする`FireworkEvent`などのデータ型定義をここに集約します。
    -   **`@skycanvas/fireworks-core`:** 花火の発射ロジック、傾きデータからVibeパラメータへの変換ロジック、生成AIへの入力生成ロジックなど、花火の「飛び方」に関するコアロジックをここにカプセル化します。
    -   **`@skycanvas/supabase-client`:** Supabaseクライアントの初期化、リアルタイム購読の共通処理、データ送信ヘルパー関数などを提供します。
-   **バージョン管理とリリース:** 共有パッケージのバージョンアップは、それを利用するアプリケーションのバージョンアップと同期して行います。SemVer（Semantic Versioning）に従い、互換性を維持します。

## 2. その他の設計判断

### 2.1. 状態管理
- **フロントエンド:** React Context APIまたはRecoil/Jotaiのような軽量な状態管理ライブラリを使用。
- **データ永続化:** Supabaseをメインのデータソースとし、クライアント側での複雑な状態管理は避ける。

### 2.2. アニメーションと物理シミュレーション
- Three.jsと組み合わせて、花火の物理的な挙動（重力、空気抵抗、爆発力）をシミュレートする。
- パーティクルシステムの最適化（GPUインスタンシング、シェーダーアニメーション）。

### 2.3. AI/生成ロジック
- **花火パターン:** 事前定義された基本パターンと、Vibeパラメータに基づく動的な変形ロジックを組み合わせる。簡単なルールベースAIから開始し、時間があればより複雑な生成モデル（例: Perlin Noise、Flockingアルゴリズム）を導入。
- **音楽生成:** Web Audio APIのオシレーターやサンプラーを動的に制御し、花火のVibe（色、大きさ）に合わせた音階、テンポ、エフェクトを生成する。AIによる自動作曲はハッカソン期間では難しい可能性が高いため、最初はルールベースの生成で実現。

### 2.4. 認証・認可
- **ユーザーIDの取得:** 匿名ユーザーとしてSupabaseに接続し、セッションごとにUUIDを生成して`user_id`として利用。LINE連携など外部認証はMVP（Minimum Viable Product）では含めない。
- **RLS (Row Level Security):** `firework_events`テーブルへの`INSERT`権限を匿名ユーザーに与える。`SELECT`権限はディスプレイアプリのみに限定するか、公開範囲を調整する。

### 2.5. エラーハンドリングとロギング
- クライアントサイドでのエラー（センサー未対応、ネットワーク切断など）はユーザーに分かりやすく表示。
- Supabaseのログ機能やSentryなどの外部サービスを活用し、バックエンドエラーを監視。

## 3. 今後の計画

1.  **環境構築:** 各アプリのプロジェクト初期設定、依存関係のインストール、Supabaseプロジェクトのセットアップ。
2.  **共通モジュールの設計と実装:** `@skycanvas/types`, `@skycanvas/fireworks-core`, `@skycanvas/supabase-client` などの共有パッケージの作成。
3.  **コア機能の実装:** スマートフォンからの傾きデータ送信、ディスプレイでの花火表示（固定パターン）。
4.  **リアルタイム連携:** Supabase Realtimeを使ったスマホ-ディスプレイ間の同期。
5.  **Vibeに基づく花火生成:** 傾きデータからVibeを生成し、花火の色や形状に反映。
6.  **サウンド連携:** 花火と同期した効果音と音楽の生成。
7.  **複数ユーザー対応:** 複数スマホからの同時操作への対応と衝突回避。
8.  **デモ準備:** パフォーマンス最適化、デモスクリプト作成、プレゼンテーション資料作成。 
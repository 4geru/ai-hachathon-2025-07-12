# Sky Canvas - p5.js 花火実装の調査

## 1. はじめに

本ドキュメントでは、Web上での花火表現をp5.jsを用いて実装するための調査結果をまとめる。これまでのThree.jsを用いたアプローチから、より描画表現の柔軟性と開発効率を考慮し、p5.jsへの移行を検討する。

## 2. 調査対象サイトと概要

### 2.1. [p5.jsで花火を実装 - KORO](https://koro-koro.com/p5js-firework/)

#### 概要

p5.jsを用いた打ち上げ花火の実装について解説している記事。画面クリック（タップ）で花火が打ち上がり、花火の種類を切り替えて表示する機能を持つ。

#### 主な特徴・学べる点

*   **花火の種類:** 「牡丹」「菊」「芯入」「冠（かむろ）菊」「柳」「型物」といった、日本の花火の具体的な種類に言及しており、それぞれの特徴に応じた表現のヒントが得られる。
*   **パラメータによる多様な花火:** コードを大きく変更することなく、パラメータの追加だけで様々な種類の花火を作成できると説明されている。これは、今後の実装において花火のバリエーションを増やす上で非常に有効なアプローチとなる。
*   **ParticleクラスとFireworkクラスの構造:**
    *   `Particle`クラスは、花火を構成する個々の粒子の動き（位置、速度、寿命など）を管理する。
    *   `Firework`クラスは、打ち上げ花火全体のロジック（打ち上げ、爆発、粒子の生成・管理）を担う。
*   **`setupExplosions()` メソッドのオーバーライド:** `Firework`クラスを継承したサブクラスで `setupExplosions()` メソッドをオーバーライドすることで、爆発時の粒子の生成方法をカスタマイズし、多様な花火の形を実現できる。
*   **アニメーションと表示:** `draw`関数内で`fireworks`配列をループし、各花火の`update()`と`display()`を呼び出すことで、アニメーションを実現している。
*   **マウス/タッチイベントのハンドリング:** `createCanvas`で作成したcanvas要素にイベントリスナーを追加することで、クリックやタッチイベントを検知し、花火の発射トリガーとしている。

#### コード例から読み取れる実装のヒント

記事内のコードから、以下のような実装のヒントが得られる。

*   **HSBカラーモードの利用:** `p.colorMode(p.HSB, 360, 100, 100, 255);` を用いてHSB（色相、彩度、明度）カラーモードを使用しており、花火の色のバリエーションを容易に生成できる。
*   **`velocityFunctions`による爆発の形状制御:** `circle`や`heart`といった関数を用いて、パーティクルの初期速度ベクトルを生成している。これにより、爆発時の花火の形状を制御している。
*   **`fireworkSettings`による詳細な設定:** 花火の閾値、パーティクル数、速度タイプ、重力、寿命、色相範囲など、多数のパラメータで花火の挙動を詳細に設定できる構造になっている。
*   **残像表現 (`history`配列):** `Particle`クラス内で`history`配列を用いてパーティクルの過去の位置を記録し、それを線で描画することで残像のような表現を実現している。

## 3. 次のステップ

現状のThree.js実装をp5.jsに移行するにあたり、上記調査結果を参考に以下の点を検討する。

*   p5.jsの描画ループとReactのコンポーネントライフサイクルの統合方法。
*   既存のSupabase連携（スマートフォンからの傾きデータ取得と送信）をp5.jsベースの描画ロジックにどのように組み込むか。
*   多段階破裂や残光・煙などの視覚効果をp5.jsでどのように表現するか。
*   「型物」花火のような特定の形状を、p5.jsの描画機能とパーティクルシステムでどのように実現するか。

--- 